# Project Ojoya - 基本設計書 (MVP)

## 1. プロジェクト概要

* **プロジェクト名:** **Ojoya (オホヤ)**
* **由来:** Spanish "Ojo" (目) + "Joya" (宝石・貴重品)。「AIの眼で隠れた宝石を見つけ出す」の意。
* **コンセプト:**
* スマホで撮影するだけで、AIエージェントが「物品特定」→「市場調査」→「価値判定」を自律的に行う。
* 断捨離、実家の片付け、遺品整理を「宝探し」のエンターテインメントに変える。


* **コアバリュー:**
* 単なる画像検索ではなく、**「売るべきか？ いくらで売れるか？」という意思決定を支援**するエージェント体験。



## 2. 機能要件 (MVP: Minimum Viable Product)

### 2.1 コア機能: 鑑定 (AI Agent)

* **Single Shot Analyze:**
* カメラで撮影した画像を解析。
* **Vision:** 画像内のメインアイテムを特定（商品名、型番、状態）。
* **Search:** 外部検索ツール (Tavily) で現在の中古市場相場（メルカリ/ヤフオク等）を取得。
* **Reasoning:** 相場レンジ（最安〜最高）と、AIによる簡易アドバイスを出力。


* **結果表示:**
* 商品名、推定価格レンジ、アドバイスを表示。
* 外部サイト（メルカリ検索結果等）への直接リンクボタン。



### 2.2 ユーザー管理 & 認証

* **ゲスト利用 (Frictionless):**
* 初回起動時は登録不要。
* アプリ内でUUIDを生成し、**iOS Keychain** に保存。これを `x-guest-id` としてAPIへ送信し、個体識別を行う。


* **会員登録 (Sign-in with Apple):**
* 機種変更や課金のために、Apple IDでのログインを提供。
* **データ引継ぎ:** ゲスト利用時のUUIDデータを、会員IDへマージ（所有権移転）する処理を実装。



### 2.3 マネタイズ & 制限 (Ticket System)

* **チケット制 (都度課金):**
* APIコスト管理のため、実行回数を厳密に制限する。
* **管理場所:** **サーバーサイド (DynamoDB)**。不正防止のため、アプリ内（ローカル）での管理は行わない。


* **付与ルール (MVP案):**
* **デイリーボーナス:** 毎日 3枚 無料付与（深夜0時リセット等はLambda等で制御、またはアクセス時に判定）。
* **リワード:** 動画広告視聴で +1枚 (MVPではUIのみ、または実装優先度低)。
* **課金:** 消耗型チケット購入 (In-App Purchase)。



## 3. UX/UI フロー

### 3.1 初回起動 (Onboarding)

1. **ウォークスルー:** 「部屋のお宝を探そう」等の紙芝居（3-4枚）。
2. **利用規約への同意:** **【重要】**「AIの結果は参考情報であり、価格を保証しない」旨への同意を必須とする（リーガル対策）。
3. **カメラ許可:** ガイドを挟んでからOSの許可ダイアログを表示。

### 3.2 メイン画面

* **カメラ:** 画面中央にターゲットガイド枠と「ここにモノを映してください」のテキストを表示。
* **チケット表示:** 画面右上に「残り回数」を常時表示。
* **撮影後:** 「Ojoyaの眼が考えている」アニメーション演出（3〜10秒の待ち時間を体感的に短くする）。

## 4. 技術スタック (Google Cloud Serverless Container Architecture)

### Mobile (Frontend)

* **Language:** Swift (SwiftUI)
* **OS:** iOS 17+
* **Local Storage:** Keychain (Guest UUID保存)
* **Auth SDK:** Firebase Authentication SDK

### Backend (API & Logic)

* **Language:** Python 3.11+
* **Framework:** **FastAPI**
* **Agent Framework:** **LangGraph** (Statefulなエージェント構築)
* **Compute:** **Cloud Run** (Docker Imageデプロイ)
* 選定理由: スケールto/fromゼロ対応、Lambdaより高速なコールドスタート、WebSocket対応。

### AI & Data

* **AI Model:** **Gemini 3.0** (Flash / Pro は検討中)
* 選定理由: MMMU-Pro 81%の業界トップVision性能、高コスト効率、GCPネイティブ統合、Google Search Grounding対応。


* **Search Tool:** **Vertex AI Search** (Standard Edition)
* 選定理由: 無料枠10,000クエリ/月、$1.50/1,000クエリの低コスト、GCPネイティブ統合。


* **Database:** **Cloud Firestore** (Native mode)
* 選定理由: サーバーレス、`FieldValue.increment()` による安全なチケット減算、リアルタイム同期対応。


* **Auth:** **Firebase Authentication** (Sign in with Apple + Anonymous Auth)
* 選定理由: ゲスト→会員へのアカウントリンク機能がネイティブサポート。

### Infrastructure

* **IaC:** **Terraform** (Google Provider)
* **Container Registry:** Artifact Registry

## 5. データ設計とセキュリティ

### Firestore Schema (`users` Collection)

```
/users/{user_id}
├── type: "GUEST" | "MEMBER"
├── ticket_count: number (3)
├── history: array [...]
├── created_at: timestamp
└── updated_at: timestamp
```

| ドキュメントID | type | ticket_count | history | created_at |
| --- | --- | --- | --- | --- |
| `guest_550e84...` | `GUEST` | `3` | `[...]` | `2026-01-07...` |
| `user_apple_...` | `MEMBER` | `10` | `[...]` | `2025-12-01...` |

### ロジックフロー (API側)

1. Request Headerを確認。
2. `Authorization` (Bearer Token) があれば **Firebase Admin SDK** で検証 → `user_id` 特定。
3. なければ `x-guest-id` を確認 → `guest_{uuid}` を `user_id` とみなす。
4. Firestoreの該当 `user_id` ドキュメントの `ticket_count` を確認。
* `> 0` なら `FieldValue.increment(-1)` で減算して処理開始。
* `0` なら `402 Payment Required` エラーを返す。



### 法的リスク対策 (免責)

* **規約:** 初回同意必須。損害賠償責任の免責を明記。
* **UI:** 結果画面に「※価格はAIによる推定値です」と注釈を常時表示。
* **System Prompt:** AIに対し「断定的な表現を避け、価格幅（レンジ）で回答すること」を指示。

## 6. 開発ロードマップ (Route A先行)

### Phase 1: Brain & Backend Core (現在の着手範囲)

* [ ] ローカルでの **FastAPI + Docker** 環境構築。
* [ ] **Gemini 3.0** との接続実装。
* [ ] **Vertex AI Search** による検索ツールの実装。
* [ ] **LangGraph** による「画像受取 → 検索 → 回答」フローの実装。

### Phase 2: User & Ticket Logic

* [ ] **Firestore** ローカル(Firebase Emulator)でのコレクション設計。
* [ ] ゲストID(UUID)判定とチケット減算ロジックの実装。

### Phase 3: Infrastructure

* [ ] **Terraform** によるGCPリソース (Cloud Run, Artifact Registry, Firestore, IAM) 定義。
* [ ] Cloud Build によるデプロイパイプラインの整備。

### Phase 4: Mobile App

* [ ] SwiftUI プロジェクト作成。
* [ ] Firebase Authentication SDK 統合。
* [ ] オンボーディング画面とカメラ機能の実装。
* [ ] API連携。

---